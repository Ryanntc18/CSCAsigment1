
@{
    ViewBag.Title = "Charge";

}

@section Scripts{
    <script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    
    <script type="text/javascript">
        // Create an instance of the Stripe object with your publishable API key

        function displayload() {
            $("#loadinggif").prop("hidden", false);
            $("#payment-form").prop("hidden", true);
        }

        var stripe = Stripe('pk_test_51I5B7mLaXDcHpE2BfPtIZe7Pd8Z2m80hivBktXXcfqGdB2tOBfRrScaU96gibvijmmbo8FFLFtKGsBP8FH7Xf9MU00gYYJnwn3');
        var elements = stripe.elements();

        var elements = stripe.elements();
        var style = {
            base: {
                color: "#32325d",
            }
        };

        var card = elements.create("card", { style: style });
        card.mount("#card-element");

        card.on('change', function (event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('payment-form');

        var response = fetch('/api/paysub').then(function (response) {
            console.log("then res: " + response);
            console.log(response);
            return response.json();
        }).then(function (res) {
            var clientSecret = res;
            console.log("then2 res: " + res);
            form.addEventListener('submit', function (ev) {
                ev.preventDefault();
                var Cname = $("#name").val();
                stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: {
                            name: Cname,
                        }
                    }
                }).then(function (result) {
                    if (result.error) {
                        // Show error to your customer (e.g., insufficient funds)
                        console.log(result.error.message);
                    } else {
                        // The payment has been processed!
                        if (result.paymentIntent.status === 'succeeded') {
                            alert("Successful Transaction.");
                            window.location.reload()
                            // Show a success message to your customer
                            // There's a risk of the customer closing the window before callback
                            // execution. Set up a webhook or plugin to listen for the
                            // payment_intent.succeeded event that handles any business critical
                            // post-payment actions.
                        }
                    }
                });
            });
        });


    </script>
}

<div class="row">
    <div class="col-4" style="width:50%;">
        <h2>Stripe payment</h2>
        <h3>Logged in as Max</h3>

        <div>
            <button><a href="/Home/Sub">Manage Subscriptions</a></button>
        </div>
        <img id="loadinggif" src="/loading.gif" alt="Loading" hidden />
        <form id="payment-form">
            <h3>Pay for new Subscription</h3>
            <h4>$10.99SGD Basic version</h4>
            <div id="card-element" style="padding: 10px 0">
                <!-- Elements will create input elements here -->
            </div>

            <!-- We'll put the error messages in this element -->
            <label for="name">Name:</label>
            <input type="text" name="name"/>
            <div id="card-errors" role="alert"></div>
            <button id="submit">Pay</button>
        </form>
    </div>
</div>


